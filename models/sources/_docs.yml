version: 2

models:
  - name: chargebee_customers_view
    description: "details about each customer on web"
    columns:
      - name: app_name
        description: "Application name, generated on Airflow load"
        tests:
          - accepted_values:
              values: ['able','hint']
          - not_null
      - name: customer_id
        description: "Identifier of the customer"
        tests:
          - unique
          - not_null
      - name: email
        description: "Email of the customer. Configured email notifications will be sent to this email."
        tests:
          - not_null
      - name: country
        description: "Country of the customer"
      - name: auto_collection
        description: "Whether payments needs to be collected automatically for this customer. Possible values are - on, off"
      - name: card_status
        description: "Current status of the card"
      - name: created_at
        description: "Timestamp indicating when this customer resource is created"
      - name: mparticle_id
        description: "? from API docs"
      - name: advertising_id
        description: "? from API docs"
      - name: acc
        description: "uk, us"
      - name: customer_portal_status
        description: "? from API docs"
      - name: load_ts
        description: "Timestamp record was inserted"
      - name: update_ts
        description: "Updated timestamp, if record was modified, else null"     

  - name: chargebee_invoices_view
    description: "details about each invoice on web"
    columns:
      - name: id
        description: "surrogate key made from site and invoice_number, EDA showed they were unique together"
        tests:
          - not_null
          - unique
          - not_one_to_many:
              field: customer_id  
      - name: app_name
        description: "Application name, generated on Airflow load"
        tests:
          - accepted_values:
              values: ['able','hint']
          - not_null
      - name: customer_id
        description: "Identifier of the customer"
        tests:
          - not_null
          - relationships:
              to: ref('chargebee_customers_view')
              field: customer_id
      - name: subscription_id
        description: "Identifier for the subscription. If not provided, it is autogenerated."
        tests:
          - not_one_to_many:
              field: customer_id
              config:
                severity: warn              
      - name: invoice_date
        description: "The document date displayed on the invoice PDF. By default, it has the same value as the effective date of the action that created the invoice (subscription creation, update, or invoice creation). This date can be backdated (set to a value in the past) while performing the actions. Backdating an invoice is done for reasons such as booking revenue for a previous date or when the subscription or non-recurring charge is effective as of a past date. However, if the invoice is created as pending, and if the site is configured to set invoice dates to the date of closing, then upon invoice closure, this date is changed to the invoice closing date."
      - name: start_date
        description: "Start date of the invoice"
      - name: paid_on
        description: "? from API docs"
      - name: amount
        description: "? from API docs"
      - name: status
        description: "Current status of this invoice"
      - name: country
        description: "? from API docs"
      - name: next_retry
        description: "Timestamp indicating when will the next attempt to collect payment for this invoice occur."
      - name: refunded_amount
        description: "The refunds issued from this Credit Note"
      - name: recurring
        description: "Boolean indicating whether this invoice belongs to a subscription"
      - name: first_invoice
        description: "? from API docs"
      - name: email
        description: "? from API docs"
      - name: tax_total
        description: "Total tax amount for this invoice"
      - name: amount_due
        description: "The unpaid amount that is due on the invoice. This is calculated as: total - amount_paid - sum of applied_credits.applied_amount - sum of adjustment_credit_notes.cn_total - sum of linked_taxes_withheld.amount."
      - name: adjustments
        description: "Total adjustments made against this invoice."
      - name: credits_applied
        description: "Total credits applied against this invoice."
      - name: payments
        description: "Payments collected successfully for the invoice. This is the sum of linked_payments[].txn_amount for all linked_payments[] that have txn_status as success."
      - name: write_off_amount
        description: "Amount written off against this invoice."
      - name: currency
        description: "? from API docs"
      - name: net_term_days
        description: "Number of days within which the invoice has to be paid"
      - name: due_date
        description: "Due date of the invoice"
      - name: voided_at
        description: "Timestamp indicating when the payment was voided or authorization expired at gateway."
      - name: invoice_number
        description: "The invoice number. Acts as a identifier for invoice and typically generated sequentially."
        tests:
          - not_null        
      - name: acc
        description: "uk, us"
      - name: dunning_status
        description: "Current dunning status of the invoice."
      - name: load_ts
        description: "Timestamp record was inserted"
      - name: update_ts
        description: "Updated timestamp, if record was modified, else null"     

  - name: chargebee_subscriptions_view
    description: "details about each subscription on web"
    columns:
      - name: app_name
        description: "Application name, generated on Airflow load"
        tests:
          - accepted_values:
              values: ['able','hint']
          - not_null
      - name: subscription_id
        description: "A unique and immutable identifier for the subscription. If not provided, it is autogenerated."
        tests:
          - unique
          - not_null
          - not_one_to_many:
              field: customer_id

      - name: customer_id
        description: "Identifier of the customer"
        tests:
          - not_null
          - relationships:
              to: ref('chargebee_customers_view')
              field: customer_id

      - name: plan_id
        description: "A unique ID for your system to identify the plan"

      - name: plan_quantity
        description: "Represents the plan quantity for this subscription"

      - name: status
        description: "Current state of the subscription"

      - name: start_date
        description: "	Applicable only for 'future' subscriptions. The scheduled start time of the subscription"

      - name: trial_start
        description: "Start of the trial period for the subscription. Presence of this value for future subscription implies the subscription will go into in_trial state when it starts"

      - name: trial_end
        description: "	End of the trial period for the subscription. Presence of this value for 'future' subscription implies the subscription will go into 'in_trial' state when it starts"

      - name: curr_term_start
        description: "Start of the current billing period of the subscription"

      - name: curr_term_end
        description: "End of the current billing period of the subscription. Subscription is renewed immediately after this"

      - name: next_billing
        description: "The date/time at which the next billing for the subscription happens. This is usually right after current_term_end unless multiple subscription terms were invoiced in advance using the terms_to_charge parameter"

      - name: remaining_billing_cycles
        description: "When the subscription is not on a contract term: this value is the number of billing cycles remaining after the current cycle, at the end of which, the subscription cancels. When the subscription is on a contract term - this value is the number of billing cycles remaining in the contract term after the current billing cycle."

      - name: created_at
        description: "The time at which the subscription was created"

      - name: started_at
        description: "Time at which the subscription was started. Is null for futuresubscriptions as it is yet to be started"

      - name: activated_at
        description: "Time at which the subscription status last changed to  active. For example, this value is updated when an in_trial or  cancelled subscription activates"

      - name: cancelled_at
        description: "Time at which subscription was cancelled or is set to be cancelled"

      - name: acc
        description: "uk, us"

      - name: cancel_reason
        description: "? from API docs"

      - name: next_billing_amount
        description: "Total invoice amount to be paid upon next renewal"

      - name: po_number
        description: "Purchase order number for this subscription"

      - name: mrr
        description: "Monthly Recurring Revenue"

      - name: currency
        description: "? from API docs"

      - name: subscription_plan_unit_price
        description: "Amount that will override the Plan's default price. The unit depends on the type of currency."

      - name: subscription_setup_fee
        description: "Amount that will override the default setup fee. The unit depends on the type of currency."

      - name: subscription_pause_date
        description: "When a pause has been scheduled, it is the date/time of scheduled pause. When the subscription is in the paused state, it is the date/time when the subscription was paused"

      - name: subscriptions_resume_date
        description: "For a paused subscription, it is the date/time when the subscription is scheduled to resume. If the pause is for an indefinite period, this value is not returned"

      - name: subscription_plan_amount
        description: "Total amount for the plan"

      - name: subscription_plan_quantity_in_decimal
        description: "The decimal representation of the quantity of the plan purchased. Returned for quantity-based plans when multi-decimal pricing is enabled"

      - name: subscription_plan_unit_price_in_decimal
        description: "The decimal representation of the price or per-unit price of the plan. The value is in major units of the currency. Always returned when multi-decimal pricing is enabled"

      - name: subscription_plan_amount_in_decimal
<<<<<<< HEAD
        description: "? from API docs"
      - name: customer_cf_mparticle_id
        description: "mparticle id"
      - name: customer_cf_cid
        description: "first id in the original array, array is usually only one id long and has duplicates"
=======
        description: "The decimal representation of the total amount for the plan, in major units of the currency. Always returned when multi-decimal pricing is enabled"
>>>>>>> 49c34b528ad1f18512bfc2e2b86d32f0e664b686
      - name: load_ts
        description: "Timestamp record was inserted"
      - name: update_ts
        description: "Updated timestamp, if record was modified, else null"     

  - name: chargebee_transactions_view
    description: "details about each transaction on web"
    columns:
      - name: id
        description: "surrogate key made from site and transaction_id"
        tests:
          - not_null
      - name: app_name
        description: "Application name, generated on Airflow load"
        tests:
          - accepted_values:
              values: ['able','hint']
          - not_null
      - name: transaction_id
        description: "? from API docs"
        tests:
          - not_null
          - not_one_to_many:
              field: customer_id
      - name: customer_id
        description: "is null only for failed transactions, and three apple pay hint transactions from summer 2021, probably testing"
        tests:
          - not_null:
              config:
                severity: warn
          - relationships:
              to: ref('chargebee_customers_view')
              field: customer_id        
      - name: invoice_number
        description: "The invoice number. Acts as a identifier for invoice and typically generated sequentially"
        tests:
          - not_null:
              config:
                severity: warn
          - relationships:
              to: ref('chargebee_invoices_view')
              field: invoice_number    
      - name: date
        description: "Indicates when this transaction occurred"
      - name: type
        description: "? from API docs"
      - name: payment_method
        description: "The payment method of this transaction"
      - name: amount
        description: "Amount for this transaction"
      - name: status
        description: "The status of this transaction"
      - name: error_text
        description: "Error message received from the payment gateway on failure"
      - name: gateway
        description: "Gateway through which this transaction was done. Applicable only for 'Card' Payment Method"
      - name: card_type
        description: "? from API docs"
      - name: currency
        description: "? from API docs"
      - name: amount_unused
        description: "This is the part of the amount which has not been invoiced yet and is therefore added to excess_payments for the customer. Applicable only for a transaction of type = payment"
      - name: amount_capturable
        description: "	This is the part of the authorized amount that is yet to be captured. When captured, the transaction is recorded as that of type = payment. Applicable only for a transaction of type = authorization"
      - name: gateway_account_id
        description: "Identifier of the gateway"
      - name: acc
        description: "uk, us"
      - name: load_ts
        description: "Timestamp record was inserted"
      - name: update_ts
        description: "Updated timestamp, if record was modified, else null"     

  - name: revenuecat_able_view
    description: "https://docs.revenuecat.com/docs/etl-exports
                  
                  All transaction data is based on the store receipts that RevenueCat has received. Receipts often have inconsistencies and quirks which may need to be considered. For example:
                  The expiration date of a purchase can be before the purchase date. This is Google's way of invalidating a transaction, for example when Google is unable to bill a user some time after a subscription renews. This doesn’t occur on iOS.
                  Google returns only 90 days of recent transaction history, so some old transactions maybe missing if Google fetch tokens were imported.
                  Apple and Google do not provide the transaction price directly, so we must rely on historical data for the products that we have. This isn’t 100% accurate in cases where the prices were changed or receipts were imported.
                  Renewal numbers start at 1, even for trials. Trial conversions increase the renewal number.
                  Data is pulled from a snapshot of the current receipt state, this means that the same transaction can be different from one delivery to another if something changed, e.g.refunds, and billing issues. You should recompute metrics for past time periods periodically to take these changes into account.
                  We try to normalize or at least annotate these quirks as much as possible, but by and large we consider receipts as the sources of truth, so any inconsistencies in the transaction data can always be traced back to the receipt"
    columns:
      - name: rc_original_app_user_id
        description: "Can be used as a unique user identifier to find all of a user's transactions.
                      ids of different formats, never null"
      - name: rc_last_seen_app_user_id_alias
        description: "Can be used together with rc_original_app_user_id to match transactions with user identifiers in your systems."
      - name: country
        description: "Last seen country of the subscriber.
                      part None, ISO 3166 alpha-2 country code."
      - name: product_identifier
        description: "The product identifier that was purchased.
                      related to subscription type"
      - name: start_time
        description: "Purchase time of transaction.
                      never null"
      - name: end_time
        description: "Expiration time of subscription. Null when is_auto_renewable = false
                      For Google Play, end_time can be before start_time to indicate an invalid transaction (e.g. billing issue).
                      can be null, probably for ongoing subscriptions"
      - name: store
        description: "The source of the transaction. Can be app_store, play_store, stripe, or promotional.
                      which app store it relates to, app_store/play_store minority of promotional which could be staff"
      - name: is_auto_renewable
        description: "true for auto-renewable subscriptions, false otherwise.
                      Boolean, very few false, never null"
      - name: is_trial_period
        description: "true if the transaction was a trial.
                      Boolean, never null"
      - name: is_in_intro_offer_period
        description: "true if the transaction is in an introductory offer period.
                      vast majority false, as this must pass for most subs, never null"
      - name: is_sandbox
        description: "true for transactions made in a sandbox environment.
                      boolean vast majority false, True could be testing, never null"
      - name: price_in_usd
        description: "The gross revenue generated from the transaction. All prices are converted to USD. Can be null if product prices haven't been collected from the user's device.
                      subs price in USD, never null, majority zero could be for ended subs or trials"
      - name: takehome_percentage
        description: "0.7 or 0.85. Use this to calculate the proceeds of a transaction.
                      mostly 0.7, some 0.85 and minority 1.0 which looks like staff and is always promotional"
      - name: store_transaction_id
        description: "orderId or transaction_identifier. ​Can be used as unique id.
                      never null"
      - name: original_store_transaction_id
        description: "orderId of first purchase or original_transaction_id. Can be used to find all related transactions for a single subscription."
      - name: refunded_at
        description: "When a refund was detected, null if none was detected. Can be checked for existence to indicate transactions which have been refunded.
                      NaT strings representing nulls where refunds didn't happen, timestamp"
      - name: unsubscribe_detected_at
        description: "When we detected an unsubscribe (opt-out of auto renew).
                      Nulls probably representing where unscribes didn't happen or weren't explicit"
      - name: billing_issues_detected_at
        description: "When we detected billing issues, null if none was detected.
                      lots of Nulls probably because billing issues aren't always detected"
      - name: purchased_currency
        description: "The currency that was used for the transaction.
                      currency of transaction, 3 char iso code"
      - name: price_in_purchased_currency
        description: "The product's price in the currency that was used for the transaction.
                      Some None entries, decimal field"
      - name: entitlement_identifiers
        description: "An array of entitlements that the transaction unlocked or null if it didn't unlock any entitlements.
                      usually {}, {subscription} or None"
      - name: renewal_number
        description: "Always starts at 1. Trial conversions are counted as renewals. is_trial_conversion is used to signify whether a transaction was a trial conversion.
                      looks to be a transaction number since starting sub"
      - name: is_trial_conversion
        description: "If true, this transaction is a trial conversion.
                      boolean, never null, assume means whether sub was a trial conversion"
      - name: presented_offering
        description: "The offering presented to users. Can be used to filter Experiment transactions.
                      None/Plan2/Plan1"
      - name: reserved_subscriber_attributes
        description: "The reserved subscriber attributes set for the subscriber. Keys begin with $.
                      json blog including ad fields and user agent fields"
      - name: custom_subscriber_attributes
        description: "The custom attributes set for the subscriber.
                      always empty, so we must not be setting anything"
      - name: platform
        description: "Last seen platform of the subscriber.
                      app platform iOS, android or None"
      - name: load_ts
        description: "timestamp record was inserted"
      - name: update_ts
        description: "timestamp record was updated, will be after load_ts"
      - name: idfa
        description: ""
      - name: idfa_updated_ts
        description: ""
      - name: idfv
        description: ""
      - name: idfv_updated_ts
        description: ""
      - name: adjustid
        description: ""
      - name: adjustid_updated_ts
        description: ""
      - name: mediasource
        description: ""
      - name: mediasource_updated_ts
        description: ""
      - name: mparticleid
        description: ""
      - name: mparticleid_updated_ts
        description: ""

  - name: revenuecat_hint_view
    description: "https://docs.revenuecat.com/docs/etl-exports
                  
                  All transaction data is based on the store receipts that RevenueCat has received. Receipts often have inconsistencies and quirks which may need to be considered. For example:
                  The expiration date of a purchase can be before the purchase date. This is Google's way of invalidating a transaction, for example when Google is unable to bill a user some time after a subscription renews. This doesn’t occur on iOS.
                  Google returns only 90 days of recent transaction history, so some old transactions maybe missing if Google fetch tokens were imported.
                  Apple and Google do not provide the transaction price directly, so we must rely on historical data for the products that we have. This isn’t 100% accurate in cases where the prices were changed or receipts were imported.
                  Renewal numbers start at 1, even for trials. Trial conversions increase the renewal number.
                  Data is pulled from a snapshot of the current receipt state, this means that the same transaction can be different from one delivery to another if something changed, e.g.refunds, and billing issues. You should recompute metrics for past time periods periodically to take these changes into account.
                  We try to normalize or at least annotate these quirks as much as possible, but by and large we consider receipts as the sources of truth, so any inconsistencies in the transaction data can always be traced back to the receipt"
    columns:
      - name: rc_original_app_user_id
        description: "Can be used as a unique user identifier to find all of a user's transactions.
                      ids of different formats, never null"
      - name: rc_last_seen_app_user_id_alias
        description: "Can be used together with rc_original_app_user_id to match transactions with user identifiers in your systems."
      - name: country
        description: "Last seen country of the subscriber.
                      part None, ISO 3166 alpha-2 country code."
      - name: product_identifier
        description: "The product identifier that was purchased.
                      related to subscription type"
      - name: start_time
        description: "Purchase time of transaction.
                      never null"
      - name: end_time
        description: "Expiration time of subscription. Null when is_auto_renewable = false
                      For Google Play, end_time can be before start_time to indicate an invalid transaction (e.g. billing issue).
                      can be null, probably for ongoing subscriptions"
      - name: store
        description: "The source of the transaction. Can be app_store, play_store, stripe, or promotional.
                      which app store it relates to, app_store/play_store minority of promotional which could be staff"
      - name: is_auto_renewable
        description: "true for auto-renewable subscriptions, false otherwise.
                      Boolean, very few false, never null"
      - name: is_trial_period
        description: "true if the transaction was a trial.
                      Boolean, never null"
      - name: is_in_intro_offer_period
        description: "true if the transaction is in an introductory offer period.
                      vast majority false, as this must pass for most subs, never null"
      - name: is_sandbox
        description: "true for transactions made in a sandbox environment.
                      boolean vast majority false, True could be testing, never null"
      - name: price_in_usd
        description: "The gross revenue generated from the transaction. All prices are converted to USD. Can be null if product prices haven't been collected from the user's device.
                      subs price in USD, never null, majority zero could be for ended subs or trials"
      - name: takehome_percentage
        description: "0.7 or 0.85. Use this to calculate the proceeds of a transaction.
                      mostly 0.7, some 0.85 and minority 1.0 which looks like staff and is always promotional"
      - name: store_transaction_id
        description: "orderId or transaction_identifier. ​Can be used as unique id.
                      never null"
      - name: original_store_transaction_id
        description: "orderId of first purchase or original_transaction_id. Can be used to find all related transactions for a single subscription."
      - name: refunded_at
        description: "When a refund was detected, null if none was detected. Can be checked for existence to indicate transactions which have been refunded.
                      NaT strings representing nulls where refunds didn't happen, timestamp"
      - name: unsubscribe_detected_at
        description: "When we detected an unsubscribe (opt-out of auto renew).
                      Nulls probably representing where unscribes didn't happen or weren't explicit"
      - name: billing_issues_detected_at
        description: "When we detected billing issues, null if none was detected.
                      lots of Nulls probably because billing issues aren't always detected"
      - name: purchased_currency
        description: "The currency that was used for the transaction.
                      currency of transaction, 3 char iso code"
      - name: price_in_purchased_currency
        description: "The product's price in the currency that was used for the transaction.
                      Some None entries, decimal field"
      - name: entitlement_identifiers
        description: "An array of entitlements that the transaction unlocked or null if it didn't unlock any entitlements.
                      usually {}, {subscription} or None"
      - name: renewal_number
        description: "Always starts at 1. Trial conversions are counted as renewals. is_trial_conversion is used to signify whether a transaction was a trial conversion.
                      looks to be a transaction number since starting sub"
      - name: is_trial_conversion
        description: "If true, this transaction is a trial conversion.
                      boolean, never null, assume means whether sub was a trial conversion"
      - name: presented_offering
        description: "The offering presented to users. Can be used to filter Experiment transactions.
                      None/Plan2/Plan1"
      - name: reserved_subscriber_attributes
        description: "The reserved subscriber attributes set for the subscriber. Keys begin with $.
                      json blog including ad fields and user agent fields"
      - name: custom_subscriber_attributes
        description: "The custom attributes set for the subscriber.
                      always empty, so we must not be setting anything"
      - name: platform
        description: "Last seen platform of the subscriber.
                      app platform iOS, android or None"
      - name: load_ts
        description: "timestamp record was inserted"
      - name: update_ts
        description: "timestamp record was updated, will be after load_ts"                        
      - name: idfa
        description: ""
      - name: idfa_updated_ts
        description: ""
      - name: idfv
        description: ""
      - name: idfv_updated_ts
        description: ""
      - name: adjustid
        description: ""
      - name: adjustid_updated_ts
        description: ""
      - name: mediasource
        description: ""
      - name: mediasource_updated_ts
        description: ""
      - name: mparticleid
        description: ""
      - name: mparticleid_updated_ts
        description: ""
